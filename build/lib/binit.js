// Generated by CoffeeScript 1.9.1

/*
 * 项目初始化
 */
var Imagemin, _, butil, color, config, fs, gutil, init, md5, path, rename,
  indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

fs = require('fs');

path = require('path');

_ = require('lodash');

Imagemin = require('imagemin');

gutil = require('gulp-util');

color = gutil.colors;

rename = require('gulp-rename');

butil = require('./butil');

config = require('../config');

md5 = butil.md5;

init = {};


/*
 * init dist, cache and watch DIRS
 */

init.dir = function() {
  var _dir, i, init_dir, len, results;
  init_dir = [config.rootPath, config.lessPath, config.jsSrcPath, config.tplSrcPath, config.htmlSrc, config.spriteSrcPath, config.spriteLessOutPath, config.cssDistPath, config.jsDistPath, config.tplDistPath, config.mapPath, config.spriteDistPath, config.cssBgDistPath, config.cssOutPath, config.jsOutPath, config.spriteImgOutPath];
  results = [];
  for (i = 0, len = init_dir.length; i < len; i++) {
    _dir = init_dir[i];
    butil.mkdirsSync(_dir);
    results.push(gutil.log(_dir + " made success!"));
  }
  return results;
};


/*
 * init map file
 */

init.map = function() {
  var _dirpath, _file, i, init_file, len, new_file, old_file, results;
  init_file = [config.jsMapName, config.cssMapName, config.spMapName];
  results = [];
  for (i = 0, len = init_file.length; i < len; i++) {
    _file = init_file[i];
    _dirpath = path.dirname(_file);
    !fs.existsSync(_dirpath) && butil.mkdirsSync(_dirpath);
    new_file = path.join(config.mapPath, _file);
    old_file = path.join(config.mapPath, "old_" + _file);
    !fs.existsSync(new_file) && fs.writeFileSync(new_file, "{}", 'utf8');
    !fs.existsSync(old_file) && fs.writeFileSync(old_file, "{}", 'utf8');
    results.push(gutil.log("" + config.mapPath + _file + " made success!"));
  }
  return results;
};


/*
 * build the three part's js libs paths
 */

init.lib = function(cb) {
  var _cb, dataPath, jsonData, namePaths;
  _cb = cb || function() {};
  namePaths = {};
  fs.readdirSync(config.jsLibPath).forEach(function(v) {
    var jsLibPath;
    jsLibPath = path.join(config.jsLibPath, v);
    if (fs.statSync(jsLibPath).isDirectory()) {
      return fs.readdirSync(jsLibPath).forEach(function(f) {
        var jsPath;
        jsPath = path.join(jsLibPath, f);
        if (fs.statSync(jsPath).isFile() && f.indexOf('.') !== 0 && f.indexOf('.js') !== -1) {
          return namePaths[v] = "../../../libs/" + v + "/" + (f.replace('.js', ''));
        }
      });
    }
  });
  jsonData = JSON.stringify(namePaths, null, 4);
  dataPath = config.dataPath;
  !fs.existsSync(dataPath) && butil.mkdirsSync(dataPath);
  fs.writeFileSync(path.join(dataPath, 'jslib.paths.json'), jsonData, 'utf8');
  gutil.log(color.green("jslib.paths.json build success"));
  return _cb();
};


/*
 * build images
 */

init.bgmap = function(cb) {
  var _cb, _imgSrcPath, _map, jsonData, makePaths;
  _cb = cb || function() {};
  _map = {};
  _imgSrcPath = config.imgSrcPath;
  console.log(_imgSrcPath);
  makePaths = function(sup_path) {
    var _ext, _sup_path;
    _sup_path = sup_path || _imgSrcPath;
    _ext = ['.png', '.jpg', '.gif'];
    return fs.readdirSync(_sup_path).forEach(function(v) {
      var _distname, _hash, _imgmin, _name, _str, _this_ext, ref, sub_Path;
      sub_Path = path.join(_sup_path, v);
      if (fs.statSync(sub_Path).isDirectory()) {
        return makePaths(sub_Path);
      } else if (fs.statSync(sub_Path).isFile() && v.indexOf('.') !== 0 && (ref = path.extname(sub_Path), indexOf.call(_ext, ref) >= 0)) {
        _name = sub_Path.replace(_imgSrcPath, '');
        _this_ext = path.extname(_name);
        _str = String(fs.readFileSync(sub_Path, 'utf8'));
        _hash = md5(_str);
        _distname = _name.replace(_this_ext, '.') + _hash.substring(0, config.hashLength) + _this_ext;
        _map[_name] = {};
        _map[_name].hash = _hash;
        _map[_name].distname = _distname;
        _imgmin = new Imagemin().src(sub_Path).dest(config.imgDistPath).use(rename(_distname));
        return _imgmin.run(function(err, files) {
          err && (function() {
            throw err;
          })();
          return console.log(files[0].path);
        });
      }
    });
  };
  makePaths(config.imgSrcPath);
  jsonData = JSON.stringify(_map, null, 2);
  !fs.existsSync(config.mapPath) && butil.mkdirsSync(config.mapPath);
  fs.writeFileSync(path.join(config.mapPath, config.cssBgMap), jsonData, 'utf8');
  gutil.log(color.green(config.cssBgMap + " build success"));
  return _cb();
};


/*
 * build require.config
 */

init.cfg = function(cb) {
  var _cb, configStr, jsLibPaths, jsPaths, jsSrcPath, key, newPaths, rCfg, shimData, val;
  _cb = cb || function() {};
  shimData = JSON.parse(fs.readFileSync(path.join(config.dataPath, 'shim.json'), 'utf8'));
  jsLibPaths = JSON.parse(fs.readFileSync(path.join(config.dataPath, 'jslib.paths.json'), 'utf8'));
  jsPaths = JSON.parse(fs.readFileSync(path.join(config.dataPath, 'paths.json'), 'utf8'));
  newPaths = {};
  for (key in jsLibPaths) {
    val = jsLibPaths[key];
    if (key !== 'require' && key !== 'almond' && key !== 'amdloader') {
      newPaths[key] = val;
    }
  }
  rCfg = {
    baseUrl: config.staticPath + 'src/js',
    paths: _.extend(newPaths, jsPaths),
    shim: shimData
  };
  jsSrcPath = config.jsSrcPath;
  configStr = "require.config(" + (JSON.stringify(rCfg, null, 4)) + ");\n";
  fs.writeFileSync(path.join(jsSrcPath, "config.js"), configStr, 'utf8');
  gutil.log(color.green("config.js build success"));
  return _cb();
};

module.exports = init;
