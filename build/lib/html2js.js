// Generated by CoffeeScript 1.9.1

/**
 * html to AMD module js function
 * @date 2015-02-14 15:36:39
 * @author pjg <iampjg@gmail.com>
 * @link http://pjg.pw
 * @version $Id$
 */
var _htmlToJs, config, fs, path;

fs = require('fs');

path = require('path');

config = require('../config');

_htmlToJs = function(folder) {
  var _tplPath, tplData, tpl_soure;
  if (folder.indexOf('.') === 0 || folder === "") {
    return false;
  }
  _tplPath = config.tplSrcPath + folder;
  tplData = {};
  fs.readdirSync(_tplPath).forEach(function(file) {
    var _file_path, file_name, file_soure;
    _file_path = path.join(_tplPath, file);
    if (fs.statSync(_file_path).isFile() && file.indexOf('.html') !== -1 && file.indexOf('.') !== 0) {
      file_name = file.replace('.html', '');
      file_soure = fs.readFileSync(_file_path, 'utf8').replace(/<!--([\s\S]*?)-->/g, '').replace(/\n/g, '').replace(/\t/g, '').replace(/\r/g, '').replace(/\s+/g, ' ').replace(/>([\n\s+]*?)</g, '><');
      if (file.indexOf('_') === 0) {
        return tplData[file_name] = "<script id=\"tpl_" + folder + file_name + "\" type=\"smcore\">" + file_soure + "</script>";
      } else {
        return tplData[file_name] = file_soure;
      }
    }
  });
  tpl_soure = "define('_tpl/" + folder + "', [], function(){ return " + (JSON.stringify(tplData)) + "; });";
  return fs.writeFileSync(path.join(config.tplOutPath, folder + '.js'), tpl_soure, 'utf8');
};

module.exports = _htmlToJs;
